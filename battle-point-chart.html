<!doctype html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>BATTLE POINT</title>
    <style type="text/css">
        @font-face {
	        font-family: 'DSEG7Classic';
	        src: url(./images/DSEG7Classic-regular.woff);
        }
        .chart-container {
            position: relative;
            background-color: #ccc;
            width: 448px;
            height: 408px;
        }
        .chart-content {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .chart-body {
            margin: 84px 0 0 82px;
            padding: 0;
            width: 284px;
            height: 284px;
        }
        .chart-background {
            position: absolute;
            width: 100%;
            height: 100%;
        }   
        .chart-total {
            position: absolute;
            margin:15px 0 0 345px;
            text-align: right;
            background-color: #333;
            color: #f0f0f0;
	        font-family: DSEG7Classic;
            font-size: 20px;
            opacity: 0.8;
            width: 64px;
            height: 20px;
        }
        .chart-input {
            margin-top: 1em;
        }
        .chart-input-params {
            width: 3em;
        }
        </style>
</head>

<body>
    <div class="chart-container">
        <div class="chart-background">
            <img src="./images/battle-point-background.png" />
        </div>
        <div class="chart-content">
            <div class="chart-body">
                <canvas id="chart-001" class="chart"></canvas>
            </div>
        </div>
        <div id="chart-total-001" class="chart-total"></div>
    </div>
    <div class="chart-input">
        <form id="chart-input-form">
            <input type="number" class="chart-input-params" id="chart-input-params-01" min="0" max="100" step="10" value="0" />
            <input type="number" class="chart-input-params" id="chart-input-params-02" min="0" max="100" step="10" value="0" />
            <input type="number" class="chart-input-params" id="chart-input-params-03" min="0" max="100" step="10" value="0" />
            <input type="number" class="chart-input-params" id="chart-input-params-04" min="0" max="100" step="10" value="0" />
            <input type="number" class="chart-input-params" id="chart-input-params-05" min="0" max="100" step="10" value="0" />
            <input type="number" class="chart-input-params" id="chart-input-params-06" min="0" max="100" step="10" value="0" />
            <input type="number" class="chart-input-params" id="chart-input-params-07" min="0" max="100" step="10" value="0" />
            <input type="number" class="chart-input-params" id="chart-input-params-08" min="0" max="100" step="10" value="0" />
            <input type="number" class="chart-input-params" id="chart-input-params-09" min="0" max="100" step="10" value="0" />
            <input type="number" class="chart-input-params" id="chart-input-params-10" min="0" max="100" step="10" value="0" />
        </form>
    </div>
    <div class="chart-output">
        <button id="chart-output-to-clipboad">Copy to clipboard</button>
        <div>
            <img id="chart-output-image" title="output-image-title" alt="output-image-alt" />
        </div>
    </div>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <script>
        var inputForm = document.getElementById("chart-input-form");
        var copyButton = document.getElementById("chart-output-to-clipboad")
        var totalArea = document.getElementById("chart-total-001");
        var ctx = document.getElementById("chart-001").getContext("2d");
        var data = {
            labels: [
                "近距離戦闘", "中距離戦闘", "遠距離戦闘", "装甲・防御", "重量　　　",
                "稼働時間　", "隠密　　　", "索敵　　　", "空中機動　", "地上機動　"],
            datasets: [
                {
                    label: "MEGAMI's Battle Points",
                    backgroundColor: "rgba(255,0,0,0.8)",
                    borderColor: "rgba(255,0,0,1)",
                    borderWidth: 1,
                    pointBackgroundColor: "rgba(255,0,0,0)",
                    pointBorderColor: "rgba(255,0,0,0)",
                    pointHoverBackgroundColor: "rgba(255,0,0,1)",
                    pointHoverBorderColor: "rgba(255,0,0,1)",
                    data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                }
            ]
        };
        var options = {
            responsive: true,
            padding: 0,
            title: {
                display: false
            },
            legend: {
                display: false
            }, scale: {
                display: false,
                gridLines: {
                    display: false,
                    drawBorder: false,
                },
                scaleLabel: {
                    display: false
                },
                ticks: {
                    display: false,
                    max: 100,
                    min: -15,
                    stepSize: 1
                },
                beforeFit: function (scale) {
                },
                afterFit: function (scale) {
                    scale.drawingArea = scale.height / 2;
                    scale.xCenter = scale.width / 2;
                    scale.yCenter = scale.height / 2;
                }
            }
        };
        var myRadarChart = new Chart(ctx, {
            type: 'radar',
            data: data,
            options: options
        });
        var currentTotalPt = 0;
        var targetTotalPt = 0;
        var setTotalPtInternal = function (totalPt) {
            // XXX Font image
            currentTotalPt = totalPt;
            totalArea.textContent = ("0000" + totalPt).slice(-4);;
        }
        var setTotalPt = function (totalPt, animate, animeSpeed) {
            animeSpeed = animeSpeed | 10;
            targetTotalPt = totalPt;
            if (animate && targetTotalPt != currentTotalPt) {
                var diff = targetTotalPt > currentTotalPt ? 1 : -1;
                setTotalPtInternal(currentTotalPt + diff);
                if (targetTotalPt != currentTotalPt) {
                    setTimeout(function () {
                        setTotalPt(totalPt, animate, animeSpeed);
                    }, animeSpeed);
                }
            } else {
                setTotalPtInternal(totalPt);
            }
        }
        var updateData = function () {
            var newData = [];
            var totalPt = 0;
            Array.prototype.forEach.call(document.getElementsByClassName("chart-input-params"), function (x) {
                var value = x.value * 1;
                newData.push(value);
                totalPt += value;
            });
            data.datasets[0].data = newData;
            myRadarChart.update();
            setTotalPt(totalPt, true);
            saveUrlParameter(newData)
        }
        var saveUrlParameter = function saveUrlParameter(params) {
            var urlParams = "params=" + params.join(",");
            window.location.hash = urlParams;
        }
        var loadUrlParameter = function () {
            var params = getParameterByName("params");
            if (params) {
                var values = params.split(",");
                var inputs = document.getElementsByClassName("chart-input-params");
                for (var i = 0; i < values.length && i < inputs.length; i++) {
                    inputs.item(i).value = values[i];
                }
            }
            updateData();
        }
        // http://stackoverflow.com/questions/33175909/copy-image-to-clipboard
        // http://stackoverflow.com/questions/400212/how-do-i-copy-to-the-clipboard-in-javascript
        selectElement = function (element) {
            var doc = document;
            if (doc.body.createTextRange) {
                var range = document.body.createTextRange();
                range.moveToElementText(element);
                range.select();
            } else if (window.getSelection) {
                var selection = window.getSelection();
                var range = document.createRange();
                range.selectNodeContents(element);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }
        var copyToClipboad = function (e) {
            // XXX 動的に色々合成した要素にする
            var targetElement = document.getElementById("chart-001");
            //var targetElement = document.getElementById("chart-input-form");
            targetElement = document.getElementById("chart-output-image")
            targetElement.src = ctx.canvas.toDataURL();
            selectElement(targetElement.parentElement);

            try {
                var successful = document.execCommand('copy');
                var msg = successful ? 'successful' : 'unsuccessful';
                console.log('Copying text command was ' + msg);
            } catch (err) {
                console.log('Oops, unable to copy');
            }
            //window.getSelection().removeAllRanges();
        }
        inputForm.onchange = updateData;
        copyButton.onclick = copyToClipboad;
    </script>
<script>
        function getParameterByName(name, url) {
            if (!url) {
                url = window.location.href;
            }
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[#&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }
        loadUrlParameter();
</script>
</body>

</html>